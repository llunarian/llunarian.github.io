---

layout: single
title: 6. 분산 시스템 모니터링
category: Site Reliability Engineering
published: false

---

>📌 이 시리즈는 ⟪사이트 신뢰성 엔지니어링⟫(벳시 베이어, 크리스 존스, 제니퍼 펫오프, 니얼 리처드 머피 지음, 제이펍, ISBN 979-11-88621-08-8) 의 내용을 개인적으로 학습하고 정리하기 위해 쓰여졌습니다. 따라서 해당 글을 인용 및 재배포하는 것에 대한 주의를 부탁드립니다.🚨

>SRE에 대해 더 알고싶으시다면 [여기](https://sre.google/) 를 참고하세요!

<br/>

이 장에서는 구글 SRE 팀의 모니터링 시스템 구축을 위한 기본적인 원리와 베스트 프랙티스를 살펴보고, 사람이 반드시 필요한 이슈는 어떤 것인지, 굳이 필요하지 이슈들은 어떻게 처리하는지에 대해 다룬다.

# 정의
### 모니터링
- 쿼리의 수와 종류, 에러의 수와 종류, 처리 시간 및 서버의 활동 시간 등 세스템에 대한 정량적 실시간 데이터를 모으고 처리하고 집계해서 보여주는 것을 말한다.
### 화이트박스(white-box) 모니터링
- 로그나 자바 가상 머신(JVM)의 프로파일링 인터페이스(profiling interface)같은 인터페이스 혹은 내부의 통계 지표를 제공하는 HTTP 핸들러 등을 이용해서 얻은 시스템의 내부 지표들을 토대로 하는 모니터링을 의미한다. 쉽게 말해 개발자들이 내부를 확인할 수 있는 모니터링이다. 쿼리 수행이나 HTTP 요청 응답에 대한 자세한 수치를 제공한다. APM도 화이트박스 모니터링에 포함된다.
### 블랙박스(black-box) 모니터링
- 사용자가 보게 되는 확인 가능한 동작들을 외부에서 테스트하는 과정을 말한다. 쉽게 말해 시스템 모니터링을 말하는데, CPU, 메모리, 대역폭 등 대부분의 리소스 모니터링이 여기에 포함된다.
- 아래 그림은 블랙박스와 화이트박스 모니터링의 차이를 이해하기 쉽게 보여준다. (출처: https://www.devopsschool.com/blog/white-box-monitoring-and-black-box-monitoring-explained/)

![](/assets/images/blackbox_whitebox.jpg){: width="400"}{: .align-center}

### 대시보드(dashboard)
- 서비스의 핵심 지표에 대한 요약 뷰를 보여준다. 보통 필터나 선택 옵션을 제공하지만, 가장 중요한 지표들을 사용자에게 보여주도록 만들어져 있다.
### 알림(alert)
- 특정한 이벤트 발생이나 지표에 도달했을 때 사람이 인식할 수 있는 통지 기능이다.
### 근본 원인
- 결함이나 에러의 주 원인을 말한다.
### 노드와 머신
- 물리 서버, 가상 머신 혹은 컨테이너에서 동작하는 커널의 단일 인스턴스를 의미하며 동의어로 사용된다.
### 푸시(push)
- 서비스가 실행하는 소프트웨어나 관련된 설정에 대한 모든 변경사항을 의미한다.

<br/>

# 왜 모니터링해야 하는가?
시스템을 모니터링해야 하는 이유는 아래와 같다.
### 장기적인 트렌드 분석
- 데이터베이스의 크기, 증감속도, 실 사용자 수의 증감 등을 파악할 수 있다.
### 시간순 혹은 실험 그룹에 대한 비교
- 서로 다른 DB 엔진의 쿼리 속도 등을 비교하거나, 캐시의 hit rate 등을 비교할 수 있다.
### 알림
- 문제가 생기거나 문제가 발생할 가능성이 있을 때 누군가가 살펴보아야 하는 경우 통지를 해야 한다.
### 대시보드
- 서비스에 대한 종합적인 정보를 파악할 수 있게 해준다.
### 임시적인 회고 분석의 수행(예를 들면 디버깅 등)
- 지연 응답 등이 발생했을 때 그 시간에 다른 어떤 일들이 발생했는지 파악할 수 있다.

<br/>

> 시스템 모니터링은 비즈니스 분석 및 좀 더 원활한 보안 취약점 분석을 위한 원천 데이터를 확보하는 데 도움이 된다. ⋯ 사람을 호출하는 것은 직원들의 시간을 고려하면 매우 비용이 많이 드는 일이다. 그 직원이 일을 하고 있다면 호출로 인해 업무의 흐름이 끊길 것이다. ⋯ 호출이 너무 빈번하면 직원들은 그냥 추측으로 넘어가거나 심한 경우 호출을 무시하게 되고, 경우에 따라서는 잦은 호출에 묻혀버린 '진짜' 호출마저 무시하게 된다. 이렇게 잦은 호출은 신속한 분석과 수정에 방해가 되므로 장애가 더 연장될 수 있다. 효과적인 알림 시스템은 정확한 신호와 낮은 오보 비율을 갖춰야 한다.
 
<br/>

# 모니터링에 대한 적절한 기대치 설정하기
- 복잡한 시스템을 계측, 수집, 표현, 알람을 적절하게 수행하는 인프라스트럭처를 잘 갖추고 있음에도, 모든 SRE팀은 '모니터링 요원'을 최소 한 명씩 두고 있다. 이 전담 인력(한명 내지 두명)은 서비스에 대한 모니터링 시스템을 구축하고 관리하는 업무를 전담한다.
- 구글 SRE는 종속성의 계층 구조가 복잡한 상황을 지양한다. 데이터베이스가 느리다는 사실을 단순히 데이터베이스가 느리다고 알람을 보내라는 식의 규칙은 피한다. 이러한 알림은 해당 현상에 대한 원인 파악에 추가적인 시간이 소요되게 된다. 따라서 인과관계를 파악하기 어려운 규칙보다 최대한 간결하게 심각한 예외를 구체적이고 빠르게 찾아낼 수 있는 모니터링 규칙을 정하는 것이 좋다.
- 잘못된 알림(noise) 비율을 낮추고 올바른 알림의 비율을 높게 유지하기 위해서는 호출을 담당하는 모니터링 시스템을 반드시 간결하고 안정적으로 운영해야 한다. 또한 사람이 확인할 알림을 발송하기 위한 규칙들은 이해하기 쉽고 문제를 명확하게 표현할 수 있어야 한다.

<br/> 

# 네 가지 결정적인 지표
> 모니터링에 있어 네 가지 결정적인 지표는 지연응답(latency), 트래픽, 에러, 그리고 서비스 포화상태(saturation)이다. 만일 사용자를 대상으로 하는 시스템에서 단 네가지 지표만을 측정할 수 있다면, 이 네 가지에 집중해야 한다.

### 지연응답
- 요청이 서비스에 의해 처리되기까지의 시간을 말한다.
- 예를 들어 HTTP 500 에러는 요청 처리에 실패했음을 의미하므로 500 에러들을 전체 지연응답에 포함시켜 버리면 잘못된 결과가 나올 수 있다. 게다가 빠르게 리턴된 에러보다는 느리게 리턴된 에러가 지연 응답 지표에서는 더 중요하다.
- 따라서 에러 응답을 그냥 무시하기 보다는 에러의 지연응답시간을 추적하는 것이 중요하다.
### 트래픽
- 시스템에 얼마나 많은 요청이 들어오는지, 높은 수준의 시스템 관련 지표를 통해 측정할 수 있다.
- 웹서비스의 경우는 주로 초당 HTTP 요청의 개수로 측정하며, 요청의 성질로 나누어 분류할 수도 있다.
- 오디오 스트리밍 시스템의 경우 네트워크 입출력이나 동시 접속 세션 수 등을 측정하는 것이 적절하다.
- 키-밸류 저장소 시스템이라면 트랜잭션의 개수나 초당 조회 수 등으로 측정하면 좋다.
### 에러
- 실패한 요청의 비율을 의미한다.
- 명시적인 에러 / 묵시적인 에러 / 정책 관련 에러 등을 모두 고려해야 한다.
- 명시적인 에러는 에러 코드가 명확히 리턴되는 경우
- 묵시적인 에러는 200 응답을 받았으나 컨텐츠가 잘못된 경우
- 정책 관련 에러는 예를 들어 모든 응답을 1초 내에 제공하기로 했을 때 1초 이상 소요된 응답은 에러라고 정의했을 경우 이다.
### 서비스 포화 상태
- 서비스가 얼마나 '포화' 상태로 동작하는지를 의미한다.
- 가장 병목이 발생하는 리소스를 집중해서 측정해야 한다. (즉, 메모리가 중요한 시스템에서는 메모리를, 입출력에 의존적인 시스템에 대해서는 입출력 지표를 보는 것이 좋다.)
- 복합적인 시스템의 경우, 부하 테스트를 통해서 문제를 보완할 수 있다. 이를 위해서는 요청의 복잡도에 영향을 주는 매개변수가 없으며, 설정을 변경할 일도 없고 부하 테스트에서 정적인 값을 도출할 수 있는 아주 간단한 서비스를 대상으로 측정하는 것이 좋다.
- 그러나 대부분의 서비스에서는 CPU 사용량이나 네트워크 대역폭 같은 간접적인 신호를 사용할 수 밖에 없으므로, **p99 같은 백분위수 응답 시간을 짧은 시간에 걸쳐 측정하면 이러한 포화 상태를 사전에 미리 알 수 있다.**
- 서비스와는 다르게 시스템의 포화 상태는 '데이터베이스 서버의 가용 디스크 공간이 4시간 안에 바닥날 것'과 같은 긴급한 상황을 의미한다.

<br/>

# 마지막 요청(혹은 실행과 성능)에 대한 고려
- 평균의 함정을 조심하자. 모니터링 기준 성능을 평균치로 잡게 될 경우, 요청 중 1% 정도는 높은 확률로 기준치에 매우 미달되는 결과가 도출되기 때문에, 대부분의 요청들이 평균적으로 처리될 것이라는 생각은 피하는 것이 좋다.
- 전체 요청에 대한 평균 응답 시간이 느려지는 것과 마지막 요청(tail of requests)이 아주 느려지는 것을 구분하는 간단한 방법은 실제 지연응답이 아니라 전체 요청의 수와 전체 지연응답을 수집하는 것이다. 즉, 요청 중에서 0~10ms / 10~30ms / 30~100ms / 100ms ~ 300ms 처럼 분포의 경계를 정하여 나누면 요청이 어떻게 분포되는지를 시각적으로 확인할 수 있다.
<br/>

# 적당한 측정 방법 선택하기
시스템의 지표들은 각기 다른 수준으로 세분화하여 측정되어야 한다. 예를 들어 보자.
- CPU 부하를 1분 단위로 관찰한다고 해서 CPU 사용률이 갑자기 치솟아 나중에 유입된 요청들에 대한 지연응답이 발생하는 현상을 파악할 수는 없다.
- 1년에 9시간 이하의 다운타임(99.9%의 연간 업타임)을 목표로 하는 웹 서비스에 대해, 200 응답 여부를 1분에 한두 번 이상 확인해야 한다면 너무 빈번하게 확인하는 것이다.
- 마찬가지로 99.9%의 가용성을 목표로 하는 서비스에 대해 하드 드라이브에 여유 공간이 있는지를 1~2분마다 한 번씩 확인하는 것 또한 무의미하다.

시스템을 측정할 때 어느 정도로 세분화할 것인지에 대해 주의를 기울여야 한다. CPU 부하를 초단위로 측정하면 유용한 데이터를 얻을 수 있는 효용보다는, 수집하고 저장하고 분석하는 데 비용이 너무 많이 든다.

<br/>

# 더욱 단순하게가 아니라 최대한 단순하게
모든 소프트웨어 시스템이 그렇겠지만, 모니터링 시스템 역시 복잡도가 증가하여 장애가 쉽게 발생하거나 변경 사항을 수용하기에 너무 복잡해져서 유지보수가 어려워진다.
그래서 모니터링 시스템을 디자인할 때는 최대한 간결함을 추구해야 한다. 특히 어떤 지표를 모니터링할 것인지를 결정할 때는 다음의 가이드라인을 반드시 염두에 두어야 한다.
- 가장 빈번하게 발생하는 사건/사고를 탐지하기 위한 규칙은 최대한 간결하고 예측 가능하며 확실해야 한다.
- 수정 빈도가 높지 않은 데이터의 수집, 집계 그리고 알림에 관련된 설정은 제거하는 것이 좋다.
- 수집은 되지만 대시보드에 노출되지 않고 알림에 사용되지도 않는 데이터는 역시 제거하는 것이 좋다.

<br/>

# 지금까지 살펴본 원리들을 결합하기
모니터링과 알림에 대한 규칙을 정의할 때 다음의 질문들을 활용하면, 모니터링 시스템이 너무 많은 알람을 보내는 좋지 않은 신세가 되지 않도록 구현하는데 도움이 될 것이다.
- 이 규칙은 해당 규칙이 존재하지 않는다면 알아챌 수 없는 긴급하고, 대처가 가능하며 즉각적으로 사용자가 인지할 수 있는 상태를 탐지할 수 있는가?
- 긴급하지 않은 알림이라면 무시할 수 있는 알람인가? 언제, 왜 이 알림을 무시할 수 있으며, 이런 알림을 받지 않으려면 어떻게 해야 할까?
- 이 알림은 분명히 사용자에게 좋지 않은 영향을 미치는 상황에 대한 알림인가? 가용 트래픽이 모두 소모되었거나 테스트 배포처럼 사용자에게 부정적인 영향을 미치지 않는 경우에도 알림이 발생하였는가?
- 이 알림에 대해 대응이 가능한가? 이 알림은 긴급한 것인가? 대응책은 안전하게 자동화가 가능한가? 알림에 대한 대응은 장기적인 수정이 될 것인가 아니면 단기적인 우회책이 될 것인가?
- 다른 사람들이 이 이슈에 대한 알림을 받아서 적어도 하나 이상의 불필요한 호출이 발생했는가?
위의 질문들은 호출(pages) 및 호출기(pagers)와 관련된 기본적인 철학을 반영하고 있다.
- 매번 호출기가 울릴 때마다 긴급한 상황임을 인지하고 그에 대응할 수 있어야 한다. 이러한 긴급 호출은 빈번한 호출로 인한 피로를 느끼지 않도록 하루에 단 몇 번 정도만 발생해야 한다.
- 모든 호출은 대응이 가능해야 한다.
- 호출에 대한 모든 대응은 사람이 판단해야 하는 것이어야 한다. 만일 호출에 대해 자동화된 응답이 이루어진다면 이 호출은 전파되어서는 안된다.
- 호출은 새로운 문제나 지금까지 보지 못한 사건에 대한 것이어야 한다.

<br/>

# 장기적 모니터링
당장 오늘 발생한 호출은 사람으로 하여금 내일 시스템을 향상시키고 싶은 욕구를 자극하므로 단기 가용성 목표를 달성할 것인지, 아니면 장기적인 관점에서 시스템의 성능을 향상시킬 것인지를 고민할 때가 있다. 모니터링 시스템에 대한 의사 결정은 장기적인 목표에 기초해서 판단하는 과정이 포함되어야 한다. 또한 장애 호출에 대해 이미 정해진 규칙에 의해 대응하는 것은 위험한 신호다. 팀의 그 누구도 이런 호출에 대해 자동화를 할 의지가 없다는 것은 팀이 스스로 만든 기술 부채를 해소하는 데 자신이 없다는 것을 암시한다. 이는 쉬쉬하지 말고 반드시 바깥으로 끄집어내어 논의해야 할 중요한 문제다.

중요한 것은 개별 장애 호출을 각기 다른 상황으로 보지 않고, 전체적인 장애 호출의 수준이 좋은 방향인지 아닌지, 적절하게 활용이 가능한 시스템인지, 팀과 장기적 전망에 보탬이 되는지 여부에 대해 생각해보는 것이다.

<br/>

# 결론
제대로 구성된 모니터링과 알림 파이프라인은 간결하고 명료하다. 이런 시스템은 증상을 탐지하는 것에 집중하며, 문제를 디버깅하기 위한 방안을 제시하여 원인 분석을 통해 스스로 학습하고 성장할 수 있는 기회를 제공한다.
다만 데이터베이스와 같은 서브시스템의 포화도와 성능에 대한 모니터링은 해당 서브시스템이 자체적으로 수행하는 것이 좋다.
이메일 알림은 그다지 큰 가치를 제공하지 못하며 소음처럼 간주되기 십상이다. 대부분 이메일 알림으로 전달되던 정보들은, 비교적 덜 심각하지만 현재 발생 중인 문제들을 모두 모니터링하는 대시보드 형태로 제공하는 것이 좋다. 또한 대시보드를 로그와 결합하면 시간순으로 발생한 이벤트들의 연관 관계를 분석할 수도 있다.
비상 대기 교대 운영 정책을 마련하고 문제에 대한 증상이나 실제로 발생한 긴급한 문제에 대한 알림을 적절하게 선택할 수 있는 시스템, 그리고 실제로 달성 가능한 목표를 설정하고 모니터링 시스템이 그에 대한 신속한 분석을 지원할 수 있도록 하기 위해서는 많은 시간과 노력이 필요하다.
