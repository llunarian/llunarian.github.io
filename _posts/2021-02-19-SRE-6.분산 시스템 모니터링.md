---

layout: single
title: 6. 분산 시스템 모니터링
category: Site Reliability Engineering
published: false

---

>📌 이 시리즈는 ⟪사이트 신뢰성 엔지니어링⟫(벳시 베이어, 크리스 존스, 제니퍼 펫오프, 니얼 리처드 머피 지음, 제이펍, ISBN 979-11-88621-08-8) 의 내용을 개인적으로 학습하고 정리하기 위해 쓰여졌습니다. 따라서 해당 글을 인용 및 재배포하는 것에 대한 주의를 부탁드립니다.🚨

>SRE에 대해 더 알고싶으시다면 [여기](https://sre.google/) 를 참고하세요!

<br/>

이 장에서는 구글 SRE 팀의 모니터링 시스템 구축을 위한 기본적인 원리와 베스트 프랙티스를 살펴보고, 사람이 반드시 필요한 이슈는 어떤 것인지, 굳이 필요하지 이슈들은 어떻게 처리하는지에 대해 다룬다.

# 정의
### 모니터링
- 쿼리의 수와 종류, 에러의 수와 종류, 처리 시간 및 서버의 활동 시간 등 세스템에 대한 정량적 실시간 데이터를 모으고 처리하고 집계해서 보여주는 것을 말한다.
### 화이트박스(white-box) 모니터링
- 로그나 자바 가상 머신(JVM)의 프로파일링 인터페이스(profiling interface)같은 인터페이스 혹은 내부의 통계 지표를 제공하는 HTTP 핸들러 등을 이용해서 얻은 시스템의 내부 지표들을 토대로 하는 모니터링을 의미한다. 쉽게 말해 개발자들이 내부를 확인할 수 있는 모니터링이다. 쿼리 수행이나 HTTP 요청 응답에 대한 자세한 수치를 제공한다. APM도 화이트박스 모니터링에 포함된다.
### 블랙박스(black-box) 모니터링
- 사용자가 보게 되는 확인 가능한 동작들을 외부에서 테스트하는 과정을 말한다. 쉽게 말해 시스템 모니터링을 말하는데, CPU, 메모리, 대역폭 등 대부분의 리소스 모니터링이 여기에 포함된다.
- 아래 그림은 블랙박스와 화이트박스 모니터링의 차이를 이해하기 쉽게 보여준다. (출처: https://www.devopsschool.com/blog/white-box-monitoring-and-black-box-monitoring-explained/)

![](/assets/images/blackbox_whitebox.jpg){: width="400"}{: .align-center}

### 대시보드(dashboard)
- 서비스의 핵심 지표에 대한 요약 뷰를 보여준다. 보통 필터나 선택 옵션을 제공하지만, 가장 중요한 지표들을 사용자에게 보여주도록 만들어져 있다.
### 알림(alert)
- 특정한 이벤트 발생이나 지표에 도달했을 때 사람이 인식할 수 있는 통지 기능이다.
### 근본 원인
- 결함이나 에러의 주 원인을 말한다.
### 노드와 머신
- 물리 서버, 가상 머신 혹은 컨테이너에서 동작하는 커널의 단일 인스턴스를 의미하며 동의어로 사용된다.
### 푸시(push)
- 서비스가 실행하는 소프트웨어나 관련된 설정에 대한 모든 변경사항을 의미한다.

<br/>

# 왜 모니터링해야 하는가?
시스템을 모니터링해야 하는 이유는 아래와 같다.
### 장기적인 트렌드 분석
- 데이터베이스의 크기, 증감속도, 실 사용자 수의 증감 등을 파악할 수 있다.
### 시간순 혹은 실험 그룹에 대한 비교
- 서로 다른 DB 엔진의 쿼리 속도 등을 비교하거나, 캐시의 hit rate 등을 비교할 수 있다.
### 알림
- 문제가 생기거나 문제가 발생할 가능성이 있을 때 누군가가 살펴보아야 하는 경우 통지를 해야 한다.
### 대시보드
- 서비스에 대한 종합적인 정보를 파악할 수 있게 해준다.
### 임시적인 회고 분석의 수행(예를 들면 디버깅 등)
- 지연 응답 등이 발생했을 때 그 시간에 다른 어떤 일들이 발생했는지 파악할 수 있다.

<br/>

> 시스템 모니터링은 비즈니스 분석 및 좀 더 원활한 보안 취약점 분석을 위한 원천 데이터를 확보하는 데 도움이 된다. ⋯ 사람을 호출하는 것은 직원들의 시간을 고려하면 매우 비용이 많이 드는 일이다. 그 직원이 일을 하고 있다면 호출로 인해 업무의 흐름이 끊길 것이다. ⋯ 호출이 너무 빈번하면 직원들은 그냥 추측으로 넘어가거나 심한 경우 호출을 무시하게 되고, 경우에 따라서는 잦은 호출에 묻혀버린 '진짜' 호출마저 무시하게 된다. 이렇게 잦은 호출은 신속한 분석과 수정에 방해가 되므로 장애가 더 연장될 수 있다. 효과적인 알림 시스템은 정확한 신호와 낮은 오보 비율을 갖춰야 한다.
 
<br/>

# 모니터링에 대한 적절한 기대치 설정하기
- 복잡한 시스템을 계측, 수집, 표현, 알람을 적절하게 수행하는 인프라스트럭처를 잘 갖추고 있음에도, 모든 SRE팀은 '모니터링 요원'을 최소 한 명씩 두고 있다. 이 전담 인력(한명 내지 두명)은 서비스에 대한 모니터링 시스템을 구축하고 관리하는 업무를 전담한다.
- 구글 SRE는 종속성의 계층 구조가 복잡한 상황을 지양한다. 데이터베이스가 느리다는 사실을 단순히 데이터베이스가 느리다고 알람을 보내라는 식의 규칙은 피한다. 이러한 알림은 해당 현상에 대한 원인 파악에 추가적인 시간이 소요되게 된다. 따라서 인과관계를 파악하기 어려운 규칙보다 최대한 간결하게 심각한 예외를 구체적이고 빠르게 찾아낼 수 있는 모니터링 규칙을 정하는 것이 좋다.
- 잘못된 알림(noise) 비율을 낮추고 올바른 알림의 비율을 높게 유지하기 위해서는 호출을 담당하는 모니터링 시스템을 반드시 간결하고 안정적으로 운영해야 한다. 또한 사람이 확인할 알림을 발송하기 위한 규칙들은 이해하기 쉽고 문제를 명확하게 표현할 수 있어야 한다.

<br/> 

# 네 가지 결정적인 지표
> 모니터링에 있어 네 가지 결정적인 지표는 지연응답(latency), 트래픽, 에러, 그리고 서비스 포화상태(saturation)이다. 만일 사용자를 대상으로 하는 시스템에서 단 네가지 지표만을 측정할 수 있다면, 이 네 가지에 집중해야 한다.

### 지연응답
- 요청이 서비스에 의해 처리되기까지의 시간을 말한다.
- 예를 들어 HTTP 500 에러는 요청 처리에 실패했음을 의미하므로 500 에러들을 전체 지연응답에 포함시켜 버리면 잘못된 결과가 나올 수 있다. 게다가 빠르게 리턴된 에러보다는 느리게 리턴된 에러가 지연 응답 지표에서는 더 중요하다.
- 따라서 에러 응답을 그냥 무시하기 보다는 에러의 지연응답시간을 추적하는 것이 중요하다.
### 트래픽
- 시스템에 얼마나 많은 요청이 들어오는지, 높은 수준의 시스템 관련 지표를 통해 측정할 수 있다.
- 웹서비스의 경우는 주로 초당 HTTP 요청의 개수로 측정하며, 요청의 성질로 나누어 분류할 수도 있다.
- 오디오 스트리밍 시스템의 경우 네트워크 입출력이나 동시 접속 세션 수 등을 측정하는 것이 적절하다.
- 키-밸류 저장소 시스템이라면 트랜잭션의 개수나 초당 조회 수 등으로 측정하면 좋다.
### 에러
- 실패한 요청의 비율을 의미한다.
- 명시적인 에러 / 묵시적인 에러 / 정책 관련 에러 등을 모두 고려해야 한다.
- 명시적인 에러는 에러 코드가 명확히 리턴되는 경우
- 묵시적인 에러는 200 응답을 받았으나 컨텐츠가 잘못된 경우
- 정책 관련 에러는 예를 들어 모든 응답을 1초 내에 제공하기로 했을 때 1초 이상 소요된 응답은 에러라고 정의했을 경우 이다.
### 서비스 포화 상태
- 서비스가 얼마나 '포화' 상태로 동작하는지를 의미한다.
- 가장 병목이 발생하는 리소스를 집중해서 측정해야 한다. (즉, 메모리가 중요한 시스템에서는 메모리를, 입출력에 의존적인 시스템에 대해서는 입출력 지표를 보는 것이 좋다.)
- 복합적인 시스템의 경우, 부하 테스트를 통해서 문제를 보완할 수 있다. 이를 위해서는 요청의 복잡도에 영향을 주는 매개변수가 없으며, 설정을 변경할 일도 없고 부하 테스트에서 정적인 값을 도출할 수 있는 아주 간단한 서비스를 대상으로 측정하는 것이 좋다.
- 그러나 대부분의 서비스에서는 CPU 사용량이나 네트워크 대역폭 같은 간접적인 신호를 사용할 수 밖에 없으므로, **p99 같은 백분위수 응답 시간을 짧은 시간에 걸쳐 측정하면 이러한 포화 상태를 사전에 미리 알 수 있다.**
- 서비스와는 다르게 시스템의 포화 상태는 '데이터베이스 서버의 가용 디스크 공간이 4시간 안에 바닥날 것'과 같은 긴급한 상황을 의미한다.

<br/>

# 마지막 요청(혹은 실행과 성능)에 대한 고려

<br/>

# 적당한 측정 방법 선택하기

<br/>

# 더욱 단순하게가 아니라 최대한 단순하게

<br/>

# 지금까지 살펴본 원리들을 결합하기

<br/>

# 장기적 모니터링
### 빅테이블 SRE:과도한 알림
### 지메일:사람이 예측 및 스크립팅할 수 있는 응답
### 한 걸음 더 나아가기

<br/>

# 결론
